<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chagpt v2</title>
  <style>
    /* INCIO RESETEO DE ESTILOS  */
    * {
      margin: 0;
      padding: 0;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    body {
      min-height: 100dvh;
    }

    input,
    button,
    textarea,
    select {
      font: inherit;
    }

    p {
      text-wrap: pretty;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      text-wrap: balance;
    }

    img,
    video,
    svg {
      height: auto;
      max-width: 100%;
    }

    @media (prefers-reduced-motion:reduce) {

      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
        transition: none;
      }
    }

    /* FIN RESETEO DE ESTILOS  */

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: grid;
      place-content: center;
      height: 100dvh;
    }

    header {
      background-color: #333;
      color: #fff;
      text-align: center;
      padding: 1rem;
    }

    main {
      padding: 1rem;
      max-width: 100%;
      height: 70vh;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
      margin-bottom: 1rem;
      scroll-behavior: smooth;
    }

    section {
      max-width: 600px;
      margin: 0 auto;
    }

    ul {
      list-style: none;
      padding: 0;
      display: flex;
      flex-direction: column;
    }

    li {
      margin-bottom: 1rem;
    }

    .message {
      padding: 1rem 1.5rem;
      border-radius: 5px;
      display: flex;
      width: 70%;
      flex-direction: column;
      gap: 0.5rem;
      margin: 0.5rem 0;

      >span:first-child {
        font-size: 0.8rem;
        padding: 0.15rem 1rem;
        width: 15%;
        height: auto;
        font-size: larger;
        font-weight: 500;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 5px;
      }

      >span:last-child {
        font-size: 0.8rem;
        padding: 0.15rem 1rem;
        width: 15%;
        height: auto;
        font-size: larger;
        font-weight: 500;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 5px;
      }

      &.user {
        background-color: #007bff;
        color: #fff;
        text-align: right;
        align-self: flex-end;
        align-items: flex-end;

        span,
        p {
          background-color: #007bff;
        }
      }

      &.bot {
        background-color: #f4f4f4;
        color: #333;
        text-align: left;
        align-self: flex-start;
        align-items: flex-start;

        span,
        p {
          background-color: #f4f4f4;
        }
      }
    }

    .message span {
      font-weight: bold;
    }

    .message.bot {
      background-color: #f4f4f4;
    }

    .message.user {
      background-color: #007bff;
      color: #fff;
      text-align: right;
    }

    #chat-form {
      display: flex;
      max-width: 600px;
      margin: 0 auto;
      padding: 1rem;
      gap: 1rem;
    }

    #chat-input {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    #chat-form button {
      padding: 0.5rem 1rem;
      border: none;
      background-color: #333;
      color: #fff;
      border-radius: 5px;
      cursor: pointer;

      &:hover {
        background-color: #555;
      }

      &:active {
        background-color: #000;
      }

      &:focus {
        outline: none;
      }

      &:disabled {
        background-color: #ccc;
        color: #333;
        cursor: not-allowed;
      }
    }

    small {
      display: block;
      text-align: center;
      margin-top: 1rem;
      color: #bbbbbb;
    }

    footer {
      background-color: #333;
      color: #fff;
      text-align: center;
      padding: 1rem;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
    }
  </style>
  <link rel="modulepreload" href="worker.js">
  <script type="module">
    import { CreateWebWorkerMLCEngine } from "https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.46/+esm"

    const $ = ( selector ) => document.querySelector( selector );
    const $$ = ( selector ) => document.querySelectorAll( selector );

    const worker = new Worker( 'worker.js' );

    const SELECTED_MODEL = 'gemma-2b-it-q4f32_1-MLC'

    const $chatForm = $( '#chat-form' );
    const $chatInput = $( '#chat-input' );
    const $chatTemplate = $( '#chat-template' );
    const $messages = $( 'ul' );
    const $container = $( 'main' );
    const $button = $( 'button' );
    const $small = $( 'small' );

    let messages = [];

    const webWorker = new Worker( 'worker.js', {
        type: 'module'
      } );

    const engine = await CreateWebWorkerMLCEngine( webWorker, SELECTED_MODEL, {
      initProgressCallback: ( { progress, text } ) => {
        $small.textContent = `${text}`;
        progress === 1 && ( $small.textContent = '' );
        progress === 0 && ( $button.disabled = true );
        progress === 1 && ( $button.disabled = false );
      }
    } )

    function addMessage( sender, message ) {
      const template = $chatTemplate.content.cloneNode( true );
      const [ span, p ] = template.querySelectorAll( 'span, p' );
      span.textContent = sender;
      p.textContent = message;
      template.querySelector( 'li' ).classList.add( 'message', sender );
      $messages.appendChild( template );
      $container.scrollTop = $container.scrollHeight;
      return p
    }

    $chatForm.onsubmit = async ( e ) => {
      e.preventDefault();
      const message = $chatInput.value;
      if ( !message ) return;
      addMessage( 'user', message );
      $chatInput.value = '';
      const userMessage = {
        role: 'user',
        content: message
      }
      messages.push( userMessage ); // Guardamos el mensaje del usuario
      const chunks = await engine.chat.completions.create( { messages, stream: true } )
      let reply = ''
      const botTextMessage = addMessage( 'assistant', '' );
      for await ( const chunk of chunks ) {
        const choise = chunk?.choices[ 0 ]
        const content = choise?.delta?.content ?? ""
        reply += content
        botTextMessage.textContent = reply
      }
      //const botMessage = reply.choices[ 0 ].message.content;
      const botReply = {
        role: 'assistant',
        content: reply
      }
      messages.push( botReply );
      $container.scrollTop = $container.scrollHeight;
      //addMessage( 'assistant', botMessage );
      //console.log( reply, 'RESPUESTA' )
    };
  </script>
</head>

<body>
  <header>
    <h1>Chagpt v2</h1>
  </header>
  <main>
    <section>
      <ul>

      </ul>
    </section>
  </main>
  <form id="chat-form">
    <input type="text" id="chat-input" placeholder="Escribe un mensaje...">
    <button type="submit">Enviar</button>
  </form>

  <br>
  <small></small>

  <template id="chat-template">
    <li class="message">
      <span></span>
      <p></p>
    </li>

    <footer>
      <p>Chagpt v2</p>
    </footer>
</body>

</html>
